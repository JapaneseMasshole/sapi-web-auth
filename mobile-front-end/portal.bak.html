<html>
  <meta charset="utf-8" />
  <link rel="icon" href="data:," />
  <head>
    <title>Tutorial App</title>
    <link rel="stylesheet" href="grid.css" />
	
    <script type="module">

import { JwtFetcher } from "./jwt-fetcher.js";
import { GridControl } from "./grid.js";

async function main() {
	const indexes = ["SPX INDEX", "INDU INDEX", "NDX INDEX", "RTY INDEX", "NKY INDEX"];

	const currency = ["CAD CURNCY", "JPY CURNCY", "EUR CURNCY", "GBP CURNCY", "ARS CURNCY"];

	// let us instantiate the part of our JS that will control
	// the data that is displayed in the our table
	const control = new GridControl(indexes, currency);

	const tokenFetcher = new JwtFetcher();
	const activeToken = await tokenFetcher.getActiveToken();
	// console.log("Token received!", activeToken);
	// Once we have a token, we will be able to send it to our server,
	// which will use it with blpapi to get us live data

	// your actual server url may differ, it depends on where you are hosting the application
	const socket = new WebSocket("ws://localhost:3000/live-data");

	socket.addEventListener("open", (event) => {
	  console.log("Server connection opened.");
	  socket.send(activeToken);
	});

	socket.addEventListener("message", (event) => {
	  try {
		const json = JSON.parse(event.data);
		console.log(json);
		control.onUpdate(json);
	  } catch (e) {
		console.error("Unexpected response", event.data);
		console.error(e);
	  }
	  /* Data represented by the following format:

	  interface Update {
		  indexes: Record<string, Delta>;
		  currency: Record<string, Delta>;
	  }

	  where Record string may equal something like 'SPX INDEX'

	  interface Delta {
		  price: number;
		  marketTime: string; // date string
		  netChange: number;
		  percentChange: number;
	  }
	*/
	});
}

main();
    </script>
  </head>
  
  <body>
      <header>
        <p class="title">Bloomberg Demo: Third Party App</p>
      </header>

      <div class="data-display-area">
        <div class="main-tables">
          <!-- leaders-table inserted here -->
          <!-- laggers-table inserted here -->
        </div>
      </div>
	</body>
</html>
